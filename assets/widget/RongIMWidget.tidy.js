function QiniuJsSDK(){var e;e="https:"===window.location.protocol?"https://up.qbox.me":"http://upload.qiniu.com",this.detectIEVersion=function(){for(var e=4,t=document.createElement("div"),n=t.getElementsByTagName("i");t.innerHTML="<!--[if gt IE "+e+"]><i></i><![endif]-->",n[0];)e++;return e>4?e:!1},this.isImage=function(e){var t,n="",o=["png","jpg","jpeg","gif","bmp"],i=/\.([a-zA-Z0-9]+)(\?|\@|$)/;if(!e||!i.test(e))return!1;t=i.exec(e),n=t[1].toLowerCase();for(var r=0,s=o.length;s>r;r++)if(n===o[r])return!0;return!1},this.getFileExtension=function(e){var t,n=e.split(".");return t=1===n.length||""===n[0]&&2===n.length?"":n.pop().toLowerCase()},this.utf8_encode=function(e){if(null===e||"undefined"==typeof e)return"";var t,n,o=e+"",i="",r=0;t=n=0,r=o.length;for(var s=0;r>s;s++){var a=o.charCodeAt(s),c=null;if(128>a)n++;else if(a>127&&2048>a)c=String.fromCharCode(a>>6|192,63&a|128);else if(63488&a^!0)c=String.fromCharCode(a>>12|224,a>>6&63|128,63&a|128);else{if(64512&a^!0)throw new RangeError("Unmatched trail surrogate at "+s);var g=o.charCodeAt(++s);if(64512&g^!0)throw new RangeError("Unmatched lead surrogate at "+(s-1));a=((1023&a)<<10)+(1023&g)+65536,c=String.fromCharCode(a>>18|240,a>>12&63|128,a>>6&63|128,63&a|128)}null!==c&&(n>t&&(i+=o.slice(t,n)),i+=c,t=n=s+1)}return n>t&&(i+=o.slice(t,r)),i},this.base64_encode=function(e){var t,n,o,i,r,s,a,c,g="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",u=0,l=0,d="",p=[];if(!e)return e;e=this.utf8_encode(e+"");do t=e.charCodeAt(u++),n=e.charCodeAt(u++),o=e.charCodeAt(u++),c=t<<16|n<<8|o,i=c>>18&63,r=c>>12&63,s=c>>6&63,a=63&c,p[l++]=g.charAt(i)+g.charAt(r)+g.charAt(s)+g.charAt(a);while(u<e.length);switch(d=p.join(""),e.length%3){case 1:d=d.slice(0,-2)+"==";break;case 2:d=d.slice(0,-1)+"="}return d},this.URLSafeBase64Encode=function(e){return e=this.base64_encode(e),e.replace(/\//g,"_").replace(/\+/g,"-")},this.createAjax=function(e){var t={};return t=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")},this.parseJSON=function(e){return window.JSON&&window.JSON.parse?window.JSON.parse(e):null===e?e:"string"==typeof e&&(e=this.trim(e),e&&/^[\],:{}\s]*$/.test(e.replace(/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,"@").replace(/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))?function(){return e}():void 0},this.trim=function(e){return null===e?"":e.replace(/^\s+|\s+$/g,"")};var t=this;this.uploader=function(n){if(!n.domain)throw"uptoken_url or domain is required!";if(!n.browse_button)throw"browse_button is required!";var o={},i=n.init&&n.init.Error,r=n.init&&n.init.FileUploaded;n.init.Error=function(){},n.init.FileUploaded=function(){},t.uptoken_url=n.uptoken_url,t.token="",t.key_handler="function"==typeof n.init.Key?n.init.Key:"",this.domain=n.domain;var s="",a={isResumeUpload:!1,resumeFilesize:0,startTime:"",currentTime:""},c=function(){var e,o,i,r=t.detectIEVersion(),s="Safari"===mOxie.Env.browser&&mOxie.Env.version<=5&&"Windows"===mOxie.Env.os&&"7"===mOxie.Env.osVersion||"Safari"===mOxie.Env.browser&&"iOS"===mOxie.Env.os&&"7"===mOxie.Env.osVersion;r&&9>=r&&n.chunk_size&&n.runtimes.indexOf("flash")>=0?n.chunk_size=0:s?n.chunk_size=0:(e=20,o=4<<e,i=plupload.parseSize(n.chunk_size),i>o&&(n.chunk_size=o))};c();var g=function(){if(n.uptoken)t.token=n.uptoken;else{var e=t.createAjax();e.open("GET",t.uptoken_url,!0),e.onreadystatechange=function(){if(4===e.readyState&&200===e.status){var n=t.parseJSON(e.responseText);t.token=n.uptoken}},e.send()}},u=function(e,o,i){var r="",s=!1;if(!n.save_key)if(s=e.getOption&&e.getOption("unique_names"),s=s||e.settings&&e.settings.unique_names){var a=t.getFileExtension(o.name);r=a?o.id+"."+a:o.id}else r="function"==typeof i?i(e,o):o.name;return r};plupload.extend(o,n,{url:e,multipart_params:{token:""}});var l=new plupload.Uploader(o);return l.bind("Init",function(e,t){g()}),l.init(),l.bind("FilesAdded",function(e,t){var n=e.getOption&&e.getOption("auto_start");n=n||e.settings&&e.settings.auto_start,n&&plupload.each(t,function(t,n){e.start()}),e.refresh()}),l.bind("BeforeUpload",function(o,i){i.speed=i.speed||0,s="",n.get_new_uptoken&&g();var r=function(o,i,r){a.startTime=(new Date).getTime();var s;s=n.save_key?{token:t.token}:{key:u(o,i,r),token:t.token};var c=n.x_vars;if(void 0!==c&&"object"==typeof c)for(var g in c)c.hasOwnProperty(g)&&("function"==typeof c[g]?s["x:"+g]=c[g](o,i):"object"!=typeof c[g]&&(s["x:"+g]=c[g]));o.setOption({url:e,multipart:!0,chunk_size:void 0,multipart_params:s})},c=o.getOption&&o.getOption("chunk_size");if(c=c||o.settings&&o.settings.chunk_size,"html5"===l.runtime&&c)if(i.size<c)r(o,i,t.key_handler);else{var d=localStorage.getItem(i.name),p=c;if(d){d=JSON.parse(d);var v=(new Date).getTime(),f=d.time||0,m=864e5;m>v-f&&100!==d.percent&&i.size===d.total?(i.percent=d.percent,i.loaded=d.offset,s=d.ctx,a.isResumeUpload=!0,a.resumeFilesize=d.offset,d.offset+p>i.size&&(p=i.size-d.offset)):localStorage.removeItem(i.name)}a.startTime=(new Date).getTime(),o.setOption({url:e+"/mkblk/"+p,multipart:!1,chunk_size:c,required_features:"chunks",headers:{Authorization:"UpToken "+t.token},multipart_params:{}})}else r(o,i,t.key_handler)}),l.bind("UploadProgress",function(e,t){a.currentTime=(new Date).getTime();var n=a.currentTime-a.startTime,o=t.loaded||0;a.isResumeUpload&&(o=t.loaded-a.resumeFilesize),t.speed=(o/n*1e3).toFixed(0)||0}),l.bind("ChunkUploaded",function(n,o,i){var r=t.parseJSON(i.response);s=s?s+","+r.ctx:r.ctx;var a=i.total-i.offset,c=n.getOption&&n.getOption("chunk_size");c=c||n.settings&&n.settings.chunk_size,c>a&&n.setOption({url:e+"/mkblk/"+a}),localStorage.setItem(o.name,JSON.stringify({ctx:s,percent:o.percent,total:i.total,offset:i.offset,time:(new Date).getTime()}))}),l.bind("Error",function(e){return function(n,o){var i="",r=o.file;if(r){switch(o.code){case plupload.FAILED:i="上传失败。请稍后再试。";break;case plupload.FILE_SIZE_ERROR:var s=n.getOption&&n.getOption("max_file_size");s=s||n.settings&&n.settings.max_file_size,i="浏览器最大可上传"+s+"。更大文件请使用命令行工具。";break;case plupload.FILE_EXTENSION_ERROR:i="文件验证失败。请稍后重试。";break;case plupload.HTTP_ERROR:if(""===o.response){i=o.message||"未知网络错误。";break}var a=t.parseJSON(o.response),c=a.error;switch(o.status){case 400:i="请求报文格式错误。";break;case 401:i="客户端认证授权失败。请重试或提交反馈。";break;case 405:i="客户端请求错误。请重试或提交反馈。";break;case 579:i="资源上传成功，但回调失败。";break;case 599:i="网络连接异常。请重试或提交反馈。";break;case 614:i="文件已存在。";try{a=t.parseJSON(a.error),c=a.error||"file exists"}catch(g){c=a.error||"file exists"}break;case 631:i="指定空间不存在。";break;case 701:i="上传数据块校验出错。请重试或提交反馈。";break;default:i="未知错误。"}i=i+"("+o.status+"："+c+")";break;case plupload.SECURITY_ERROR:i="安全配置错误。请联系网站管理员。";break;case plupload.GENERIC_ERROR:i="上传失败。请稍后再试。";break;case plupload.IO_ERROR:i="上传失败。请稍后再试。";break;case plupload.INIT_ERROR:i="网站配置错误。请联系网站管理员。",l.destroy();break;default:i=o.message+o.details}e&&e(n,o,i)}n.refresh()}}(i)),l.bind("FileUploaded",function(o){return function(i,r,a){var c=function(e,i,r){if(n.downtoken_url){var s=t.createAjax();s.open("POST",n.downtoken_url,!0),s.setRequestHeader("Content-type","application/x-www-form-urlencoded"),s.onreadystatechange=function(){if(4===s.readyState)if(200===s.status){var n;try{n=t.parseJSON(s.responseText)}catch(a){throw"invalid json format"}var c={};plupload.extend(c,t.parseJSON(r),n),o&&o(e,i,JSON.stringify(c))}else l.trigger("Error",{status:s.status,response:s.responseText,file:i,code:plupload.HTTP_ERROR})},s.send("key="+t.parseJSON(r).key+"&domain="+n.domain)}else o&&o(e,i,r)};a.response=a.response.replace(/'/g,'"');var g=t.parseJSON(a.response);if(s=s?s:g.ctx){var d="";n.save_key||(d=u(i,r,t.key_handler),d=d?"/key/"+t.URLSafeBase64Encode(d):"");var p="/fname/"+t.URLSafeBase64Encode(r.name),v=n.x_vars,f="",m="";if(void 0!==v&&"object"==typeof v)for(var h in v)v.hasOwnProperty(h)&&("function"==typeof v[h]?f=t.URLSafeBase64Encode(v[h](i,r)):"object"!=typeof v[h]&&(f=t.URLSafeBase64Encode(v[h])),m+="/x:"+h+"/"+f);var y=e+"/mkfile/"+r.size+d+p+m,I=t.createAjax();I.open("POST",y,!0),I.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),I.setRequestHeader("Authorization","UpToken "+t.token),I.onreadystatechange=function(){if(4===I.readyState)if(localStorage.removeItem(r.name),200===I.status){var e=I.responseText;c(i,r,e)}else l.trigger("Error",{status:I.status,response:I.responseText,file:r,code:-200})},I.send(s)}else c(i,r,a.response)}}(r)),l},this.getUrl=function(e){if(!e)return!1;e=encodeURI(e);var t=this.domain;return"/"!==t.slice(t.length-1)&&(t+="/"),t+e},this.imageView2=function(e,t){var n=e.mode||"",o=e.w||"",i=e.h||"",r=e.q||"",s=e.format||"";if(!n)return!1;if(!o&&!i)return!1;var a="imageView2/"+n;return a+=o?"/w/"+o:"",a+=i?"/h/"+i:"",a+=r?"/q/"+r:"",a+=s?"/format/"+s:"",t&&(a=this.getUrl(t)+"?"+a),a},this.imageMogr2=function(e,t){var n=e["auto-orient"]||"",o=e.thumbnail||"",i=e.strip||"",r=e.gravity||"",s=e.crop||"",a=e.quality||"",c=e.rotate||"",g=e.format||"",u=e.blur||"",l="imageMogr2";return l+=n?"/auto-orient":"",l+=o?"/thumbnail/"+o:"",l+=i?"/strip":"",l+=r?"/gravity/"+r:"",l+=a?"/quality/"+a:"",l+=s?"/crop/"+s:"",l+=c?"/rotate/"+c:"",l+=g?"/format/"+g:"",l+=u?"/blur/"+u:"",t&&(l=this.getUrl(t)+"?"+l),l},this.watermark=function(e,t){var n=e.mode;if(!n)return!1;var o="watermark/"+n;if(1===n){var i=e.image||"";if(!i)return!1;o+=i?"/image/"+this.URLSafeBase64Encode(i):""}else{if(2!==n)return!1;var r=e.text?e.text:"",s=e.font?e.font:"",a=e.fontsize?e.fontsize:"",c=e.fill?e.fill:"";if(!r)return!1;o+=r?"/text/"+this.URLSafeBase64Encode(r):"",o+=s?"/font/"+this.URLSafeBase64Encode(s):"",o+=a?"/fontsize/"+a:"",o+=c?"/fill/"+this.URLSafeBase64Encode(c):""}var g=e.dissolve||"",u=e.gravity||"",l=e.dx||"",d=e.dy||"";return o+=g?"/dissolve/"+g:"",o+=u?"/gravity/"+u:"",o+=l?"/dx/"+l:"",o+=d?"/dy/"+d:"",t&&(o=this.getUrl(t)+"?"+o),o},this.imageInfo=function(e){if(!e)return!1;var t,n=this.getUrl(e)+"?imageInfo",o=this.createAjax(),i=this;return o.open("GET",n,!1),o.onreadystatechange=function(){4===o.readyState&&200===o.status&&(t=i.parseJSON(o.responseText))},o.send(),t},this.exif=function(e){if(!e)return!1;var t,n=this.getUrl(e)+"?exif",o=this.createAjax(),i=this;return o.open("GET",n,!1),o.onreadystatechange=function(){4===o.readyState&&200===o.status&&(t=i.parseJSON(o.responseText))},o.send(),t},this.get=function(e,t){return t&&e?"exif"===e?this.exif(t):"imageInfo"===e?this.imageInfo(t):!1:!1},this.pipeline=function(e,t){var n,o,i="[object Array]"===Object.prototype.toString.call(e),r="";if(i){for(var s=0,a=e.length;a>s;s++){if(n=e[s],!n.fop)return!1;switch(n.fop){case"watermark":r+=this.watermark(n)+"|";break;case"imageView2":r+=this.imageView2(n)+"|";break;case"imageMogr2":r+=this.imageMogr2(n)+"|";break;default:o=!0}if(o)return!1}if(t){r=this.getUrl(t)+"?"+r;var c=r.length;"|"===r.slice(c-1)&&(r=r.slice(0,c-1))}return r}return!1}}var RongWebIMWidget;!function(e){var t;!function(e){angular.module("RongWebIMWidget.conversation",[])}(t=e.conversation||(e.conversation={}))}(RongWebIMWidget||(RongWebIMWidget={}));var RongWebIMWidget;!function(e){var t;!function(e){angular.module("RongWebIMWidget.conversationlist",[])}(t=e.conversationlist||(e.conversationlist={}))}(RongWebIMWidget||(RongWebIMWidget={}));var RongWebIMWidget;!function(e){angular.module("RongWebIMWidget",["RongWebIMWidget.conversation","RongWebIMWidget.conversationlist","Evaluate"])}(RongWebIMWidget||(RongWebIMWidget={}));var RongWebIMWidget;!function(e){var t=window.navigator.userAgent,n=function(){function e(){}return e.timeCompare=function(e,t){var n=e.toString(),o=t.toString();return n.substring(0,n.lastIndexOf(":"))==o.substring(0,o.lastIndexOf(":"))},e.cloneObject=function(t){if(!t)return null;var n;if("[object Array]"==Object.prototype.toString.call(t)){n=[];for(var o=t.length;o--;)n[o]=e.cloneObject(t[o]);return n}if("object"==typeof t){n={};for(var i in t)n[i]=t[i];return n}return t},e.checkType=function(e){var t=Object.prototype.toString.call(e);return t.substring(8,t.length-1).toLowerCase()},e.browser={version:(t.match(/.+(?:rv|it|ra|chrome|ie)[\/: ]([\d.]+)/)||[0,"0"])[1],safari:/webkit/.test(t),opera:/opera|opr/.test(t),msie:/msie|trident/.test(t)&&!/opera/.test(t),chrome:/chrome/.test(t),mozilla:/mozilla/.test(t)&&!/(compatible|webkit|like gecko)/.test(t)},e.escapeSymbol={escapeHtml:function(e){return e?(e=e.replace(/</g,"&lt;"),e=e.replace(/>/g,"&gt;"),e=e.replace(/"/g,"&quot;"),e=e.replace(/'/g,"&#039;")):""}},e.getFocus=function(t){if(t.focus(),t.createTextRange){var n=t.createTextRange();n.moveStart("character",t.value.length),n.collapse(!0),n.select()}else if(t.selectionStart)t.selectionStart=t.value.length;else if(window.getSelection&&t.lastChild){var o=window.getSelection(),i=document.createRange();e.browser.msie?i.setStart(t.lastChild,t.lastChild.length):i.setStart(t.firstChild,t.firstChild.length),o.removeAllRanges(),o.addRange(i)}},e.ImageHelper={getThumbnail:function(t,n,o){var i=document.createElement("canvas"),r=i.getContext("2d"),s=new Image;s.onload=function(){var e,a,c=s.width*s.height;if(c>n){var g=Math.sqrt(c/n);g=Math.ceil(100*g)/100,e=s.width/g,a=s.height/g}else e=s.width,a=s.height;i.width=e,i.height=a,r.drawImage(s,0,0,e,a);try{var u=i.toDataURL("image/jpeg",.5);u=u.substr(23),o(t,u)}catch(l){o(t,null)}},s.src=e.ImageHelper.getFullPath(t)},getFullPath:function(e){return window.URL=window.URL||window.webkitURL,window.URL&&window.URL.createObjectURL?window.URL.createObjectURL(e):null}},e.CookieHelper={setCookie:function(e,t,n){if(n){var o=new Date;o.setDate(o.getDate()+n),document.cookie=e+"="+encodeURI(t)+";expires="+o.toUTCString()}else document.cookie=e+"="+encodeURI(t)+";"},getCookie:function(e){var t=document.cookie.indexOf(e+"=");if(-1!=t){var n=document.cookie.indexOf(";",t);return-1==n&&(n=document.cookie.length),decodeURI(document.cookie.substring(t+e.length+1,n))}return""},removeCookie:function(e){var t=this.getCookie(e);t&&this.setCookie(e,"con",-1)}},e}();e.Helper=n;var o=function(){function e(){}return e.isNotificationSupported=function(){return"function"==typeof Notification},e.requestPermission=function(){e.isNotificationSupported()&&Notification.requestPermission(function(e){})},e.onclick=function(e){},e.showNotification=function(t){if(!e.isNotificationSupported())return void console.log("the current browser does not support Notification API");if("granted"!==Notification.permission)return void console.log("the current page has not been granted for notification");if(e.desktopNotification){var n=t.title;delete t.title;var o=new Notification(n,t);o.onshow=function(){setTimeout(function(){o.close()},5e3)},o.onclick=function(){window.focus(),e.onclick(o),o.close()},o.onerror=function(){},o.onclose=function(){}}},e.desktopNotification=!0,e}();e.NotificationHelper=o;var i=function(){function e(){}return e.GetFactoryFor=function(e){var t=function(){for(var t=[],n=0;n<arguments.length;n++)t[n-0]=arguments[n];var o=Object.create(e.prototype);return o.constructor.apply(o,t),o};return t.$inject=e.$inject,t},e}();e.DirectiveFactory=i;var r=function(){function e(){}return e.instance=function(){return new e},e.prototype.link=function(e,t,n){n.ngSrc||n.$set("src",n.errSrc),t.bind("error",function(){n.src!=n.errSrc&&n.$set("src",n.errSrc)})},e}(),s=function(){function e(){this.restrict="A",this.require="?ngModel"}return e.prototype.link=function(e,t,n,o){function i(e){return e.replace(new RegExp("<[\\s\\S.]*?>","ig"),"")}function r(){var e=t.html();e=e.replace(/^<br>$/i,""),e=e.replace(/<br>/gi,"\n"),n.stripBr&&"<br>"==e&&(e=""),o.$setViewValue(e)}var s=t[0];e.$watch(function(){return o.$modelValue},function(e){document.activeElement!==s&&(""!==e&&e!==n.placeholder||(s.innerHTML=n.placeholder,s.style.color="#a9a9a9"))}),t.bind("focus",function(){s.innerHTML==n.placeholder&&(s.innerHTML=""),s.style.color=""}),t.bind("blur",function(){""===s.innerHTML&&(s.innerHTML=n.placeholder,s.style.color="#a9a9a9")}),o&&(t.bind("paste",function(e){var t=this;t.innerHTML;n&&clearTimeout(n);var n=setTimeout(function(){t.innerHTML=i(t.innerHTML),o.$setViewValue(t.innerHTML),n=null},50)}),o.$render=function(){t.html(o.$viewValue||"")},t.bind("keydown paste",r),t.bind("input",r))},e}(),a=function(){function e(){this.restrict="A",this.require="?ngModel",this.scope={fun:"&",ctrlenter:"=",content:"="}}return e.prototype.link=function(e,t,n,o){e.ctrlenter=e.ctrlenter||!1,t.bind("keypress",function(t){e.ctrlenter?(t.ctrlKey===!0&&13===t.keyCode||10===t.keyCode)&&(e.fun(),e.$parent.$apply(),t.preventDefault()):t.ctrlKey!==!1||t.shiftKey!==!1||13!==t.keyCode&&10!==t.keyCode?t.ctrlKey===!0&&13===t.keyCode||10===t.keyCode:(e.fun(),e.$parent.$apply(),t.preventDefault())})},e}();angular.module("RongWebIMWidget").directive("errSrc",r.instance).directive("contenteditableDire",i.GetFactoryFor(s)).directive("ctrlEnterKeys",i.GetFactoryFor(a)).filter("trustHtml",["$sce",function(e){return function(t){return e.trustAsHtml(t)}}]).filter("historyTime",["$filter",function(e){return function(t){var n=new Date;return t.toDateString()===n.toDateString()?e("date")(t,"HH:mm"):t.toDateString()===new Date(n.setTime(n.getTime()-1)).toDateString()?"昨天"+e("date")(t,"HH:mm"):e("date")(t,"yyyy-MM-dd HH:mm")}}])}(RongWebIMWidget||(RongWebIMWidget={}));var RongWebIMWidget;!function(e){var t;!function(t){var n="http://7xogjk.com1.z0.glb.clouddn.com/",o=function(){function t(t,o,i,r,s,a,c){function g(){c.getFileToken().then(function(e){o._uploadToken=e,u()})}function u(){d&&d.destroy(),d=Qiniu.uploader({runtimes:"html5,html4",browse_button:"upload-file",container:"funcPanel",drop_element:"inputMsg",max_file_size:"100mb",dragdrop:!0,chunk_size:"4mb",uptoken:o._uploadToken,domain:n,get_new_uptoken:!1,filters:{mime_types:[{title:"Image files",extensions:"jpg,gif,png,jpeg,bmp"}],prevent_duplicates:!1},multi_selection:!1,auto_start:!0,init:{FilesAdded:function(e,t){},BeforeUpload:function(e,t){},UploadProgress:function(e,t){},UploadComplete:function(){},FileUploaded:function(n,i,s){return t.conversation.targetId&&t.conversation.targetType?(s=s.replace(/'/g,'"'),s=JSON.parse(s),void RongIMLib.RongIMClient.getInstance().getFileUrl(RongIMLib.FileType.IMAGE,s.name,{onSuccess:function(n){e.Helper.ImageHelper.getThumbnail(i.getNative(),6e4,function(i,s){var a=RongIMLib.ImageMessage.obtain(s,n.downloadUrl),c=l.packDisplaySendMessage(a,e.MessageType.ImageMessage);RongIMLib.RongIMClient.getInstance().sendMessage(t.conversation.targetType,t.conversation.targetId,a,{onSuccess:function(){r.updateConversations().then(function(){})},onError:function(){}}),o._addHistoryMessages(e.Message.convert(c)),t.$apply(function(){t.scrollBar()}),g()})},onError:function(){}})):void alert("请先选择一个会话目标。")},Error:function(e,t,n){console.log(t),g()}}})}this.$scope=t,this.conversationServer=o,this.WebIMWidget=i,this.conversationListServer=r,this.widgetConfig=s,this.providerdata=a,this.RongIMSDKServer=c;var l=this;o.changeConversation=function(e){l.changeConversation(e)},o.handleMessage=function(e){l.handleMessage(e)},o._handleConnectSuccess=function(){g()},t.evaluate={type:1,showevaluate:!1,valid:!1,onConfirm:function(e){e&&(1==t.evaluate.type?c.evaluateHumanCustomService(o.current.targetId,e.stars,e.describe).then(function(){},function(){}):c.evaluateHumanCustomService(o.current.targetId,e.value,e.describe).then(function(){},function(){})),RongIMLib.RongIMClient.getInstance().stopCustomeService(o.current.targetId,{onSuccess:function(){},onError:function(){}}),l.closeState()},onCancle:function(){t.evaluate.showSelf=!1}},t._inputPanelState=e.EnumInputPanelType.person,t.$watch("showemoji",function(e,n){e!==n&&(t.emojiList&&0!=t.emojiList.length||(t.emojiList=RongIMLib.RongIMEmoji.emojis.slice(0,66)))}),document.addEventListener("click",function(e){t.showemoji&&-1==e.target.className.indexOf("iconfont-smile")&&t.$apply(function(){t.showemoji=!1})}),t.$watch("showSelf",function(e,t){e!==t&&(e&&o._uploadToken?u():d&&d.destroy())}),t.$watch("_inputPanelState",function(t,n){t!==n&&(t==e.EnumInputPanelType.person&&o._uploadToken?u():d&&d.destroy())}),t.$watch("conversation.messageContent",function(e,n){e!==n&&t.conversation&&RongIMLib.RongIMClient.getInstance().saveTextMessageDraft(+t.conversation.targetType,t.conversation.targetId,e)}),t.getHistory=function(){var n=t.conversation.targetType+"_"+t.conversation.targetId,i=o._cacheHistory[n];i.splice(0,i.length),o._getHistoryMessages(+t.conversation.targetType,t.conversation.targetId,20).then(function(t){t.has&&o._cacheHistory[n].unshift(new e.GetMoreMessagePanel)})},t.getMoreMessage=function(){var n=t.conversation.targetType+"_"+t.conversation.targetId;o._cacheHistory[n].shift(),o._cacheHistory[n].shift(),o._getHistoryMessages(+t.conversation.targetType,t.conversation.targetId,20).then(function(t){t.has&&o._cacheHistory[n].unshift(new e.GetMoreMessagePanel)})},t.switchPerson=function(){RongIMLib.RongIMClient.getInstance().switchToHumanMode(o.current.targetId,{onSuccess:function(){},onError:function(){}})},t.send=function(){if(!t.conversation.targetId||!t.conversation.targetType)return void alert("请先选择一个会话目标。");if(""!=t.conversation.messageContent){var n=RongIMLib.RongIMEmoji.symbolToEmoji(t.conversation.messageContent),i=RongIMLib.TextMessage.obtain(n),s=new RongIMLib.UserInfo(a.currentUserInfo.userId,a.currentUserInfo.name,a.currentUserInfo.portraitUri);i.user=s;try{RongIMLib.RongIMClient.getInstance().sendMessage(+t.conversation.targetType,t.conversation.targetId,i,{onSuccess:function(e){r.updateConversations().then(function(){})},onError:function(e){}})}catch(c){}var g=l.packDisplaySendMessage(i,e.MessageType.TextMessage),u=e.Message.convert(g);o._addHistoryMessages(u),t.scrollBar(),t.conversation.messageContent="";var d=document.getElementById("inputMsg");e.Helper.getFocus(d)}};var d;t.close=function(){if(i.onCloseBefore&&"function"==typeof i.onCloseBefore){i.onCloseBefore({close:function(n){o.current.targetType==e.EnumConversationType.CUSTOMER_SERVICE?t.evaluate.valid?t.evaluate.showSelf=!0:t.evaluate.onCancle():l.closeState()}})}else o.current.targetType==e.EnumConversationType.CUSTOMER_SERVICE?t.evaluate.valid?t.evaluate.showSelf=!0:t.evaluate.onCancle():l.closeState()},t.minimize=function(){i.display=!1}}return t.prototype.closeState=function(){var e=this;this.WebIMWidget.onClose&&"function"==typeof this.WebIMWidget.onClose&&setTimeout(function(){e.WebIMWidget.onClose(e.$scope.conversation)},1),this.widgetConfig.displayConversationList?this.$scope.showSelf=!1:this.WebIMWidget.display=!1,this.$scope.messageList=[],this.$scope.conversation=null,this.conversationServer.current=null},t.prototype.changeConversation=function(t){var n=this;if(n.widgetConfig.displayConversationList?n.$scope.showSelf=!0:(n.$scope.showSelf=!0,n.WebIMWidget.display=!0),!t||!t.targetId)return n.$scope.conversation={},n.$scope.messageList=[],n.conversationServer.current=null,void setTimeout(function(){n.$scope.$apply()});var o=t.targetType+"_"+t.targetId;t.targetType!=e.EnumConversationType.CUSTOMER_SERVICE||n.conversationServer.current&&n.conversationServer.current.targetId==t.targetId||n.RongIMSDKServer.startCustomService(t.targetId),n.conversationServer.current=t,n.$scope.conversation=t,n.$scope.conversation.messageContent=RongIMLib.RongIMClient.getInstance().getTextMessageDraft(t.targetType,t.targetId)||"",n.$scope.messageList=n.conversationServer._cacheHistory[o]=n.conversationServer._cacheHistory[o]||[],0==n.$scope.messageList.length?n.conversationServer._getHistoryMessages(t.targetType,t.targetId,3).then(function(t){n.$scope.messageList.length>0&&(n.$scope.messageList.unshift(new e.TimePanl(n.$scope.messageList[0].sentTime)),t.has&&n.$scope.messageList.unshift(new e.GetMoreMessagePanel),setTimeout(function(){n.$scope.$apply()}),n.$scope.scrollBar())}):(setTimeout(function(){n.$scope.$apply()}),n.$scope.scrollBar())},t.prototype.handleMessage=function(t){var n=this;if(n.$scope.conversation&&t.targetId==n.$scope.conversation.targetId&&t.conversationType==n.$scope.conversation.targetType){n.$scope.$apply();var o=null;switch(t.messageType){case e.MessageType.HandShakeResponseMessage:n.conversationServer._customService.type=t.content.data.serviceType,n.conversationServer._customService.companyName=t.content.data.companyName,n.conversationServer._customService.robotName=t.content.data.robotName,n.conversationServer._customService.robotIcon=t.content.data.robotIcon,n.conversationServer._customService.robotWelcome=t.content.data.robotWelcome,n.conversationServer._customService.humanWelcome=t.content.data.humanWelcome,n.conversationServer._customService.noOneOnlineTip=t.content.data.noOneOnlineTip,"1"==t.content.data.serviceType?(n.changeCustomerState(e.EnumInputPanelType.robot),t.content.data.robotWelcome&&(o=this.packReceiveMessage(RongIMLib.TextMessage.obtain(t.content.data.robotWelcome),e.MessageType.TextMessage))):"3"==t.content.data.serviceType?(t.content.data.robotWelcome&&(o=this.packReceiveMessage(RongIMLib.TextMessage.obtain(t.content.data.robotWelcome),e.MessageType.TextMessage)),n.changeCustomerState(e.EnumInputPanelType.robotSwitchPerson)):n.changeCustomerState(e.EnumInputPanelType.person),n.$scope.evaluate.valid=!1,n.$scope.evaluate.valid=!0;break;case e.MessageType.ChangeModeResponseMessage:switch(t.content.data.status){case 1:n.conversationServer._customService.human.name=t.content.data.name||"客服人员",n.conversationServer._customService.human.headimgurl=t.content.data.headimgurl,n.changeCustomerState(e.EnumInputPanelType.person);break;case 2:"2"==n.conversationServer._customService.type?n.changeCustomerState(e.EnumInputPanelType.person):"1"!=n.conversationServer._customService.type&&"3"!=n.conversationServer._customService.type||n.changeCustomerState(e.EnumInputPanelType.robotSwitchPerson);break;case 3:n.changeCustomerState(e.EnumInputPanelType.robot),o=this.packReceiveMessage(RongIMLib.InformationNotificationMessage.obtain("你被拉黑了"),e.MessageType.InformationNotificationMessage);break;case 4:n.changeCustomerState(e.EnumInputPanelType.person),o=n.packReceiveMessage(RongIMLib.InformationNotificationMessage.obtain("已经是人工了"),e.MessageType.InformationNotificationMessage)}break;case e.MessageType.TerminateMessage:0==t.content.code?(n.$scope.evaluate.valid=!0,n.$scope.close()):"1"==n.conversationServer._customService.type?n.changeCustomerState(e.EnumInputPanelType.robot):n.changeCustomerState(e.EnumInputPanelType.robotSwitchPerson);break;case e.MessageType.SuspendMessage:t.messageDirection==e.MessageDirection.SEND&&n.closeState();break;case e.MessageType.CustomerStatusUpdateMessage:switch(Number(t.content.serviceStatus)){case 1:"1"==n.conversationServer._customService.type?n.changeCustomerState(e.EnumInputPanelType.robot):n.changeCustomerState(e.EnumInputPanelType.robotSwitchPerson);break;case 2:n.changeCustomerState(e.EnumInputPanelType.person);break;case 3:n.changeCustomerState(e.EnumInputPanelType.notService)}}if(o){var i=e.Message.convert(o);n.addCustomService(i),n.conversationServer._addHistoryMessages(i)}n.addCustomService(t),setTimeout(function(){n.$scope.$apply(),n.$scope.scrollBar()},200)}},t.prototype.addCustomService=function(t){return t.content&&!t.content.userInfo?(t.conversationType==e.EnumConversationType.CUSTOMER_SERVICE&&t.content&&t.messageDirection==e.MessageDirection.RECEIVE?"1"==this.conversationServer._customService.currentType?t.content.userInfo={name:this.conversationServer._customService.human.name||"客服人员",portraitUri:this.conversationServer._customService.human.headimgurl||this.conversationServer._customService.robotIcon}:t.content.userInfo={name:this.conversationServer._customService.robotName,portraitUri:this.conversationServer._customService.robotIcon}:t.conversationType==e.EnumConversationType.CUSTOMER_SERVICE&&t.content&&t.messageDirection==e.MessageDirection.SEND&&(t.content.userInfo={name:"我",portraitUri:this.providerdata.currentUserInfo.portraitUri}),t):void 0},t.prototype.changeCustomerState=function(t){this.$scope._inputPanelState=t,t==e.EnumInputPanelType.person?(this.$scope.evaluate.type=1,this.conversationServer._customService.currentType="1",this.conversationServer.current.title=this.conversationServer._customService.human.name||"客服人员"):(this.$scope.evaluate.type=2,this.conversationServer._customService.currentType="2",this.conversationServer.current.title=this.conversationServer._customService.robotName)},t.prototype.packDisplaySendMessage=function(e,t){var n=new RongIMLib.Message,o=new RongIMLib.UserInfo(this.providerdata.currentUserInfo.userId,this.providerdata.currentUserInfo.name||"我",this.providerdata.currentUserInfo.portraitUri);return e.user=o,n.content=e,n.conversationType=this.$scope.conversation.targetType,n.targetId=this.$scope.conversation.targetId,n.senderUserId=this.providerdata.currentUserInfo.userId,n.messageDirection=RongIMLib.MessageDirection.SEND,n.sentTime=(new Date).getTime()-(RongIMLib.RongIMClient.getInstance().getDeltaTime()||0),n.messageType=t,n},t.prototype.packReceiveMessage=function(e,t){var n=new RongIMLib.Message,o=null;return e.userInfo=o,n.content=e,n.conversationType=this.$scope.conversation.targetType,n.targetId=this.$scope.conversation.targetId,n.senderUserId=this.$scope.conversation.targetId,n.messageDirection=RongIMLib.MessageDirection.RECEIVE,n.sentTime=(new Date).getTime()-(RongIMLib.RongIMClient.getInstance().getDeltaTime()||0),n.messageType=t,n},t.$inject=["$scope","ConversationServer","WebIMWidget","ConversationListServer","WidgetConfig","ProviderData","RongIMSDKServer"],t}();angular.module("RongWebIMWidget.conversation").controller("conversationController",o)}(t=e.conversation||(e.conversation={}))}(RongWebIMWidget||(RongWebIMWidget={}));var RongWebIMWidget;!function(e){var t;!function(t){var n=e.DirectiveFactory.GetFactoryFor,o=function(){function e(e){this.conversationServer=e,this.restrict="E",this.templateUrl="./src/ts/conversation/conversation.tpl.html",this.controller="conversationController"}return e.prototype.link=function(e,t){window.jQuery&&window.jQuery.nicescroll&&$("#Messages").niceScroll({cursorcolor:"#0099ff",cursoropacitymax:1,touchbehavior:!0,cursorwidth:"8px",cursorborder:"0",cursorborderradius:"5px"}),e.scrollBar=function(){setTimeout(function(){var e=document.getElementById("Messages");e&&(e.scrollTop=e.scrollHeight)},0)}},e.$inject=["ConversationServer"],e}(),i=function(){function t(){this.restrict="E",this.scope={item:"=",content:"="},this.template='<div style="display:inline-block"></div>'}return t.prototype.link=function(t,n,o){n.find("div").append(t.item),n.on("click",function(){t.content.messageContent=t.content.messageContent||"",t.content.messageContent=t.content.messageContent.replace(/\n$/,""),t.content.messageContent=t.content.messageContent+t.item.children[0].getAttribute("name"),t.$parent.$apply();var n=document.getElementById("inputMsg");e.Helper.getFocus(n)})},t}(),r=function(){function e(){this.restrict="E",this.scope={msg:"="},this.template='<div class=""><div class="rongcloud-Message-text"><pre class="rongcloud-Message-entry" ng-bind-html="msg.content|trustHtml"><br></pre></div></div>'}return e.prototype.link=function(e,t,n){var o=/\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*/gi,i=[];e.msg.content=e.msg.content.replace(o,function(e){return i.push(e),"[email`"+(i.length-1)+"]"});var r=/(((ht|f)tp(s?))\:\/\/)?((25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9])\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0)\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0)\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[0-9])|(www.|[a-zA-Z].)[a-zA-Z0-9\-\.]+\.(com|cn|edu|gov|mil|net|org|biz|info|name|museum|us|ca|uk|me|im))(\:[0-9]+)*(\/($|[a-zA-Z0-9\.\,\;\?\'\\\+&amp;%\$#\=~_\-]+))*/gi;e.msg.content=e.msg.content.replace(r,function(e,t){return t?'<a target="_blank" href="'+e+'">'+e+"</a>":'<a target="_blank" href="//'+e+'">'+e+"</a>"});for(var s=0,a=i.length;a>s;s++)e.content=e.content.replace("[email`"+s+"]",'<a href="mailto:'+i[s]+'">'+i[s]+"<a>")},e}(),s=function(){
function e(){this.restrict="E",this.scope={msg:"="},this.template='<div class=""><div class="rongcloud-Message-text"><pre class="rongcloud-Message-entry" style="">维护中 由于我们的服务商出现故障，融云官网及相关服务也受到影响，给各位用户带来的不便，还请谅解。  您可以通过 <a href="#">【官方微博】</a>了解</pre></div></div>'}return e}(),a=function(){function e(){this.restrict="E",this.scope={msg:"="},this.template='<div class=""><div class="rongcloud-Message-img"><span id="{{\'rebox_\'+$id}}"  class="rongcloud-Message-entry" style=""><a href="{{msg.imageUri}}" target="_black"><img ng-src="{{msg.content}}"  data-image="{{msg.imageUri}}" alt=""/></a></span></div></div>'}return e.prototype.link=function(e,t,n){var o=new Image;o.src=e.msg.imageUri,setTimeout(function(){window.jQuery&&window.jQuery.rebox&&$("#rebox_"+e.$id).rebox({selector:"a",zIndex:999999,theme:"rongcloud-rebox"}).bind("rebox:open",function(){var e=document.getElementsByClassName("rongcloud-rebox")[0];e.onclick=function(t){if("img"!=t.target.tagName.toLowerCase()){var n=document.getElementsByClassName("rongcloud-rebox-close")[0];n.click(),e=null,n=null}}})}),o.onload=function(){e.$apply(function(){e.msg.content=e.msg.imageUri})},e.showBigImage=function(){}},e}(),c=function(){function e(t){this.$timeout=t,this.restrict="E",this.scope={msg:"="},this.template='<div class=""><div class="rongcloud-Message-audio"><span class="rongcloud-Message-entry" style=""><span class="rongcloud-audioBox rongcloud-clearfix " ng-click="play()" ng-class="{\'rongcloud-animate\':isplaying}" ><i></i><i></i><i></i></span><div style="display: inline-block;" ><span class="rongcloud-audioTimer">{{msg.duration}}”</span><span class="rongcloud-audioState" ng-show="msg.isUnReade"></span></div></span></div></div>',e.prototype.link=function(e,n,o){e.msg.duration=parseInt(e.msg.duration||e.msg.content.length/1024),RongIMLib.RongIMVoice.preLoaded(e.msg.content),e.play=function(){RongIMLib.RongIMVoice.stop(e.msg.content),e.isplaying?(e.isplaying=!1,t.cancel(e.timeoutid)):(e.msg.isUnReade=!1,RongIMLib.RongIMVoice.play(e.msg.content,e.msg.duration),e.isplaying=!0,e.timeoutid&&t.cancel(e.timeoutid),e.timeoutid=t(function(){e.isplaying=!1},1e3*e.msg.duration))}}}return e.$inject=["$timeout"],e}(),g=function(){function e(){this.restrict="E",this.scope={msg:"="},this.template='<div class=""><div class="rongcloud-Message-map"><span class="rongcloud-Message-entry" style=""><div class="rongcloud-mapBox"><img ng-src="{{msg.content}}" alt=""><span>{{msg.poi}}</span></div></span></div></div>'}return e}(),u=function(){function e(){this.restrict="E",this.scope={msg:"="},this.template='<div class=""><div class="rongcloud-Message-image-text"><span class="rongcloud-Message-entry" style=""><div class="rongcloud-image-textBox"><h4>{{msg.title}}</h4><div class="rongcloud-cont rongcloud-clearfix"><img ng-src="{{msg.imageUri}}" alt=""><div>{{msg.content}}</div></div></div></span></div></div>'}return e}();angular.module("RongWebIMWidget.conversation").directive("rongConversation",n(o)).directive("emoji",n(i)).directive("textmessage",n(r)).directive("includinglinkmessage",n(s)).directive("imagemessage",n(a)).directive("voicemessage",n(c)).directive("locationmessage",n(g)).directive("richcontentmessage",n(u))}(t=e.conversation||(e.conversation={}))}(RongWebIMWidget||(RongWebIMWidget={}));var RongWebIMWidget;!function(e){var t;!function(t){var n=function(){function e(){this.human={}}return e}(),o=function(){function t(t,o){this.$q=t,this.providerdata=o,this.current=new e.Conversation,this._cacheHistory={},this._customService=new n}return t.prototype.unshiftHistoryMessages=function(t,n,o){var i=n+"_"+t,r=this._cacheHistory[i]=this._cacheHistory[i]||[];r[0]&&r[0].sentTime&&r[0].panelType!=e.PanelType.Time&&o.sentTime&&(e.Helper.timeCompare(r[0].sentTime,o.sentTime)||r.unshift(new e.TimePanl(r[0].sentTime))),r.unshift(o)},t.prototype._getHistoryMessages=function(t,n,o,i){var r=this.$q.defer(),s=this;return RongIMLib.RongIMClient.getInstance().getHistoryMessages(t,n,i?0:null,o,{onSuccess:function(o,i){for(var a=o.length;a--;){var c=e.Message.convert(o[a]);s.unshiftHistoryMessages(n,t,c),c.content&&s.providerdata.getUserInfo&&!function(t){s.providerdata.getUserInfo(t.senderUserId,{onSuccess:function(n){t.content.userInfo=new e.UserInfo(n.userId,n.name,n.portraitUri)}})}(c)}r.resolve({data:o,has:i})},onError:function(e){r.reject(e)}}),r.promise},t.prototype._addHistoryMessages=function(t){var n=t.conversationType+"_"+t.targetId,o=this._cacheHistory[n]=this._cacheHistory[n]||[];o[o.length-1]&&o[o.length-1].panelType!=e.PanelType.Time&&o[o.length-1].sentTime&&t.sentTime&&(e.Helper.timeCompare(o[o.length-1].sentTime,t.sentTime)||o.push(new e.TimePanl(t.sentTime))),o.push(t)},t.prototype.updateUploadToken=function(){var e=this;RongIMLib.RongIMClient.getInstance().getFileToken(RongIMLib.FileType.IMAGE,{onSuccess:function(t){e._uploadToken=t.token},onError:function(){}})},t.$inject=["$q","ProviderData"],t}();angular.module("RongWebIMWidget.conversation").service("ConversationServer",o)}(t=e.conversation||(e.conversation={}))}(RongWebIMWidget||(RongWebIMWidget={}));var RongWebIMWidget;!function(e){var t;!function(e){var t=function(){function e(e,t,n){this.$scope=e,this.conversationListServer=t,this.WebIMWidget=n,e.minbtn=function(){n.display=!1},e.conversationListServer=t}return e.$inject=["$scope","ConversationListServer","WebIMWidget"],e}();angular.module("RongWebIMWidget.conversationlist").controller("conversationListController",t)}(t=e.conversationlist||(e.conversationlist={}))}(RongWebIMWidget||(RongWebIMWidget={}));var RongWebIMWidget;!function(e){var t;!function(t){var n=e.DirectiveFactory.GetFactoryFor,o=function(){function e(){this.restrict="E",this.templateUrl="./src/ts/conversationlist/conversationList.tpl.html",this.controller="conversationListController"}return e.prototype.link=function(e,t){window.jQuery&&window.jQuery.nicescroll&&$(t).find(".rongcloud-content").niceScroll({cursorcolor:"#0099ff",cursoropacitymax:1,touchbehavior:!1,cursorwidth:"8px",cursorborder:"0",cursorborderradius:"5px"})},e}(),i=function(){function t(n,o,i){this.conversationServer=n,this.conversationListServer=o,this.RongIMSDKServer=i,this.restrict="E",this.scope={item:"="},this.template='<div class="rongcloud-chatList"><div class="rongcloud-chat_item " ng-class="{\'rongcloud-online\':item.onLine}"><div class="rongcloud-ext"><p class="rongcloud-attr clearfix"><span class="rongcloud-badge" ng-show="item.unreadMessageCount>0">{{item.unreadMessageCount>99?"99+":item.unreadMessageCount}}</span><i class="rongcloud-sprite rongcloud-no-remind" ng-click="remove($event)"></i></p></div><div class="rongcloud-photo"><img class="rongcloud-img" ng-src="{{item.portraitUri}}" err-src="http://7xo1cb.com1.z0.glb.clouddn.com/rongcloudkefu2.png" alt=""><i ng-show="!!$parent.data.getOnlineStatus&&item.targetType==1" class="rongcloud-Presence rongcloud-Presence--stacked rongcloud-Presence--mainBox"></i></div><div class="rongcloud-info"><h3 class="rongcloud-nickname"><span class="rongcloud-nickname_text" title="{{item.title}}">{{item.title}}</span></h3></div></div></div>',t.prototype.link=function(t,r,s){r.on("click",function(){n.changeConversation(new e.Conversation(t.item.targetType,t.item.targetId,t.item.title)),t.item.unreadMessageCount>0&&(i.clearUnreadCount(t.item.targetType,t.item.targetId),i.sendReadReceiptMessage(t.item.targetId,Number(t.item.targetType)),o.updateConversations())}),t.remove=function(e){e.stopPropagation(),i.removeConversation(t.item.targetType,t.item.targetId).then(function(){n.current.targetType==t.item.targetType&&n.current.targetId==t.item.targetId,o.updateConversations()},function(e){})}}}return t.$inject=["ConversationServer","ConversationListServer","RongIMSDKServer"],t}();angular.module("RongWebIMWidget.conversationlist").directive("rongConversationList",n(o)).directive("conversationItem",n(i))}(t=e.conversationlist||(e.conversationlist={}))}(RongWebIMWidget||(RongWebIMWidget={}));var RongWebIMWidget;!function(e){var t;!function(t){var n=function(){function t(e,t,n,o,i){this.$q=e,this.providerdata=t,this.widgetConfig=n,this.RongIMSDKServer=o,this.conversationServer=i,this._conversationList=[],this._onlineStatus=[]}return t.prototype.updateConversations=function(){var t=this.$q.defer(),n=this;return RongIMLib.RongIMClient.getInstance().getConversationList({onSuccess:function(o){n._conversationList.splice(0,n._conversationList.length);for(var i=0,r=o.length;r>i;i++){var s=e.Conversation.onvert(o[i]);switch(s.targetType){case RongIMLib.ConversationType.PRIVATE:"function"==e.Helper.checkType(n.providerdata.getUserInfo)&&!function(e,t){n.providerdata.getUserInfo(e.targetId,{onSuccess:function(n){e.title=n.name,e.portraitUri=n.portraitUri,t.conversationTitle=n.name,t.portraitUri=n.portraitUri}})}(s,o[i]);break;case RongIMLib.ConversationType.GROUP:"function"==e.Helper.checkType(n.providerdata.getGroupInfo)&&!function(e,t){n.providerdata.getGroupInfo(e.targetId,{onSuccess:function(n){e.title=n.name,e.portraitUri=n.portraitUri,t.conversationTitle=n.name,t.portraitUri=n.portraitUri}})}(s,o[i]);break;case RongIMLib.ConversationType.CHATROOM:s.title="聊天室："+s.targetId}n._conversationList.push(s)}if(n._onlineStatus.forEach(function(t){var o=n._getConversation(e.EnumConversationType.PRIVATE,t.id);o&&(o.onLine=t.status)}),n.widgetConfig.displayConversationList)RongIMLib.RongIMClient.getInstance().getTotalUnreadCount({onSuccess:function(e){n.providerdata.totalUnreadCount=e||0,t.resolve()},onError:function(){}});else{var a=n.conversationServer.current;a&&a.targetId&&n.RongIMSDKServer.getConversation(a.targetType,a.targetId).then(function(e){e&&e.unreadMessageCount?(n.providerdata.totalUnreadCount=e.unreadMessageCount||0,t.resolve()):(n.providerdata.totalUnreadCount=0,t.resolve())})}},onError:function(e){t.reject(e)}},null),t.promise},t.prototype._getConversation=function(e,t){for(var n=0,o=this._conversationList.length;o>n;n++)if(this._conversationList[n].targetType==e&&this._conversationList[n].targetId==t)return this._conversationList[n];return null},t.prototype.startRefreshOnlineStatus=function(){var e=this;e.widgetConfig.displayConversationList&&e.providerdata.getOnlineStatus&&(e._getOnlineStatus(),e.__intervale&&clearInterval(this.__intervale),e.__intervale=setInterval(function(){e._getOnlineStatus()},3e4))},t.prototype._getOnlineStatus=function(){var e=this,t=e._conversationList.map(function(e){return e.targetId});e.providerdata.getOnlineStatus(t,{onSuccess:function(t){e._onlineStatus=t,e.updateConversations()}})},t.prototype.stopRefreshOnlineStatus=function(){clearInterval(this.__intervale),this.__intervale=null},t.$inject=["$q","ProviderData","WidgetConfig","RongIMSDKServer","ConversationServer"],t}();angular.module("RongWebIMWidget.conversationlist").service("ConversationListServer",n)}(t=e.conversationlist||(e.conversationlist={}))}(RongWebIMWidget||(RongWebIMWidget={}));var RongWebIMWidget;!function(e){var t=195,n=50,o=195,i=3,r=function(){function r(t,n,o,i,r,s,a){this.$q=t,this.conversationServer=n,this.conversationListServer=o,this.providerdata=i,this.widgetConfig=r,this.RongIMSDKServer=s,this.$log=a,this.display=!1,this.connected=!1,this.EnumConversationType=e.EnumConversationType,this.EnumConversationListPosition=e.EnumConversationListPosition}return r.prototype.init=function(r){var s=this;if(!window.RongIMLib||!window.RongIMLib.RongIMClient)return void(s.widgetConfig._config=r);var a=s.widgetConfig.style;angular.extend(s.widgetConfig,r),angular.extend(a,r.style),r.desktopNotification&&e.NotificationHelper.requestPermission();var c=document.getElementById("rongcloud-playsound");c&&"string"==typeof s.widgetConfig.voiceUrl?(c.src=s.widgetConfig.voiceUrl,s.widgetConfig.voiceNotification=!0):s.widgetConfig.voiceNotification=!1;var g=document.getElementById("rong-conversation"),u=document.getElementById("rong-conversation-list"),l=document.getElementById("rong-widget-minbtn");if(s.widgetConfig.__isKefu&&(l=document.getElementById("rong-widget-minbtn-kefu")),a)if(g.style.height=a.height+"px",g.style.width=a.width+"px",u.style.height=a.height+"px",a.positionFixed?(u.style.position="fixed",l.style.position="fixed",g.style.position="fixed"):(u.style.position="absolute",l.style.position="absolute",g.style.position="absolute"),s.widgetConfig.displayConversationList){if(l.style.display="inline-block",u.style.display="inline-block",s.widgetConfig.conversationListPosition==e.EnumConversationListPosition.left)isNaN(a.left)||(u.style.left=a.left+"px",l.style.left=a.left+"px",g.style.left=a.left+t+i+"px"),isNaN(a.right)||(u.style.right=a.right+a.width+i+"px",l.style.right=a.right+a.width+i+"px",g.style.right=a.right+"px");else{if(s.widgetConfig.conversationListPosition!=e.EnumConversationListPosition.right)throw new Error("config conversationListPosition value is invalid");isNaN(a.left)||(u.style.left=a.left+a.width+i+"px",l.style.left=a.left+a.width+i+"px",g.style.left=a.left+"px"),isNaN(a.right)||(u.style.right=a.right+"px",l.style.right=a.right+"px",g.style.right=a.right+t+i+"px")}isNaN(a.top)||(u.style.top=a.top+"px",l.style.top=a.top+a.height-n+"px",g.style.top=a.top+"px"),isNaN(a.bottom)||(u.style.bottom=a.bottom+"px",l.style.bottom=a.bottom+"px",g.style.bottom=a.bottom+"px")}else l.style.display="inline-block",u.style.display="none",g.style.left=a.left+"px",g.style.right=a.right+"px",g.style.top=a.top+"px",g.style.bottom=a.bottom+"px",l.style.top=a.top+a.height-n+"px",l.style.bottom=a.bottom+"px",l.style.left=a.left+a.width/2-o/2+"px",l.style.right=a.right+a.width/2-o/2+"px";0==s.widgetConfig.displayMinButton&&(l.style.display="none"),s.RongIMSDKServer.init(s.widgetConfig.appkey),s.RongIMSDKServer.connect(s.widgetConfig.token).then(function(t){s.conversationListServer.updateConversations(),s.conversationListServer.startRefreshOnlineStatus(),s.conversationServer._handleConnectSuccess&&s.conversationServer._handleConnectSuccess(),"function"==e.Helper.checkType(s.widgetConfig.onSuccess)&&s.widgetConfig.onSuccess(t),"function"==e.Helper.checkType(s.providerdata.getUserInfo)&&s.providerdata.getUserInfo(t,{onSuccess:function(t){s.providerdata.currentUserInfo=new e.UserInfo(t.userId,t.name,t.portraitUri)}})},function(e){e.tokenError?s.widgetConfig.onError&&"function"==typeof s.widgetConfig.onError&&s.widgetConfig.onError({code:0,info:"token 无效"}):s.widgetConfig.onError&&"function"==typeof s.widgetConfig.onError&&s.widgetConfig.onError({code:e.errorCode})}),s.RongIMSDKServer.setConnectionStatusListener({onChanged:function(e){switch(s.providerdata.connectionState=!1,e){case RongIMLib.ConnectionStatus.CONNECTED:s.$log.debug("链接成功"),s.providerdata.connectionState=!0;break;case RongIMLib.ConnectionStatus.CONNECTING:s.$log.debug("正在链接");break;case RongIMLib.ConnectionStatus.KICKED_OFFLINE_BY_OTHER_CLIENT:s.$log.debug("其他设备登录");break;case RongIMLib.ConnectionStatus.NETWORK_UNAVAILABLE:s.$log.debug("网络不可用");break;default:s.$log.debug(e)}}}),s.RongIMSDKServer.setOnReceiveMessageListener({onReceived:function(t){s.$log.debug(t);var n=e.Message.convert(t);switch("function"==e.Helper.checkType(s.providerdata.getUserInfo)&&n.content&&s.providerdata.getUserInfo(n.senderUserId,{onSuccess:function(t){t&&(n.content.userInfo=new e.UserInfo(t.userId,t.name,t.portraitUri))}}),t.messageType){case e.MessageType.VoiceMessage:n.content.isUnReade=!0;case e.MessageType.TextMessage:case e.MessageType.LocationMessage:case e.MessageType.ImageMessage:case e.MessageType.RichContentMessage:s.addMessageAndOperation(n);var o=1==s.providerdata.voiceSound&&c&&t.messageDirection==e.MessageDirection.RECEIVE&&s.widgetConfig.voiceNotification,i=s.conversationServer.current&&s.conversationServer.current.targetType==n.conversationType&&s.conversationServer.current.targetId==n.targetId,r=(document.hidden||!s.display)&&t.messageDirection==e.MessageDirection.RECEIVE&&s.widgetConfig.desktopNotification;(s.widgetConfig.displayConversationList&&o||!s.widgetConfig.displayConversationList&&o&&i)&&c.play(),(r&&s.widgetConfig.displayConversationList||!s.widgetConfig.displayConversationList&&r&&i)&&e.NotificationHelper.showNotification({title:n.content.userInfo.name,icon:"",body:e.Message.messageToNotification(t),data:{targetId:n.targetId,targetType:n.conversationType}});break;case e.MessageType.ContactNotificationMessage:break;case e.MessageType.InformationNotificationMessage:s.addMessageAndOperation(n);break;case e.MessageType.UnknownMessage:break;case e.MessageType.ReadReceiptMessage:t.messageDirection==e.MessageDirection.SEND&&s.RongIMSDKServer.clearUnreadCount(t.conversationType,t.targetId)}s.onReceivedMessage&&s.onReceivedMessage(n),s.conversationServer.handleMessage(n),!document.hidden&&s.display&&s.conversationServer.current&&s.conversationServer.current.targetType==n.conversationType&&s.conversationServer.current.targetId==n.targetId&&t.messageDirection==e.MessageDirection.RECEIVE&&t.messageType!=e.MessageType.ReadReceiptMessage&&(s.RongIMSDKServer.clearUnreadCount(s.conversationServer.current.targetType,s.conversationServer.current.targetId),s.RongIMSDKServer.sendReadReceiptMessage(s.conversationServer.current.targetId,s.conversationServer.current.targetType)),s.conversationListServer.updateConversations().then(function(){})}}),window.onfocus=function(){s.conversationServer.current&&s.conversationServer.current.targetId&&s.display&&s.RongIMSDKServer.getConversation(s.conversationServer.current.targetType,s.conversationServer.current.targetId).then(function(e){e&&e.unreadMessageCount>0&&(s.RongIMSDKServer.clearUnreadCount(s.conversationServer.current.targetType,s.conversationServer.current.targetId),s.RongIMSDKServer.sendReadReceiptMessage(s.conversationServer.current.targetId,s.conversationServer.current.targetType),s.conversationListServer.updateConversations().then(function(){}))})}},r.prototype.addMessageAndOperation=function(t){var n=t.conversationType+"_"+t.targetId,o=this.conversationServer._cacheHistory[n]=this.conversationServer._cacheHistory[n]||[];0==o.length&&(t.conversationType!=e.EnumConversationType.CUSTOMER_SERVICE&&o.push(new e.GetHistoryPanel),o.push(new e.TimePanl(t.sentTime))),this.conversationServer._addHistoryMessages(t)},r.prototype.setConversation=function(t,n,o){this.conversationServer.changeConversation(new e.Conversation(t,n,o))},r.prototype.setUserInfoProvider=function(e){this.providerdata.getUserInfo=e},r.prototype.setGroupInfoProvider=function(e){this.providerdata.getGroupInfo=e},r.prototype.setOnlineStatusProvider=function(e){this.providerdata.getOnlineStatus=e},r.prototype.show=function(){this.display=!0},r.prototype.hidden=function(){this.display=!1},r.prototype.getCurrentConversation=function(){return this.conversationServer.current},r.$inject=["$q","ConversationServer","ConversationListServer","ProviderData","WidgetConfig","RongIMSDKServer","$log"],r}();e.WebIMWidget=r,angular.module("RongWebIMWidget").service("WebIMWidget",r)}(RongWebIMWidget||(RongWebIMWidget={}));var Evaluate;!function(e){var t=function(){function e(t){this.$timeout=t,this.restrict="E",this.scope={type:"=",display:"=",enter:"&confirm",dcancle:"&cancle"},this.templateUrl="./src/ts/evaluate/evaluate.tpl.html",e.prototype.link=function(e,n){function o(n){e.end=!0,n?t(function(){e.display=!1,e.end=!1,e.enter({data:n})},800):(e.display=!1,e.end=!1,e.enter({data:n}))}var i=[!1,!1,!1,!1,!1],r=[{display:"答非所问"},{display:"理解能力差"},{display:"一问三不知"},{display:"不礼貌"}],s=!1;e.stars=i,e.labels=RongWebIMWidget.Helper.cloneObject(r),e.end=!1,e.displayDescribe=!1,e.data={stars:0,value:0,describe:"",label:""},e.$watch("display",function(t,n){t!==n&&(s=!1,e.displayDescribe=!1,e.labels=RongWebIMWidget.Helper.cloneObject(r),e.data={stars:0,value:0,describe:"",label:""})}),e.mousehover=function(t){!s&&(e.data.stars=t)},e.confirm=function(t){void 0!=t?(s=!0,1==e.type?(e.data.stars=t,5!=e.data.stars?e.displayDescribe=!0:o(e.data)):(e.data.value=t,e.data.value===!1?e.displayDescribe=!0:o(e.data))):o(null)},e.commit=function(){o(e.data)},e.cancle=function(){e.display=!1,e.dcancle()}}}return e.$inject=["$timeout"],e}();angular.module("Evaluate",[]).directive("evaluatedir",RongWebIMWidget.DirectiveFactory.GetFactoryFor(t))}(Evaluate||(Evaluate={}));var RongWebIMWidget;!function(e){var t;!function(e){e[e.left=1]="left",e[e.right=2]="right"}(t||(t={}));var n=function(){function n(e){this.WebIMWidget=e,this.defaultconfig={__isKefu:!0},this.KefuPostion=t}return n.prototype.init=function(n){var o=this;angular.extend(this.defaultconfig,n);var i={right:20};n.position&&(i=n.position==t.left?{left:20,bottom:0,width:325,positionFixed:!0}:{right:20,bottom:0,width:325,positionFixed:!0}),i.width=this.defaultconfig.style.width,i.height=this.defaultconfig.style.height,this.defaultconfig.style=i,o.WebIMWidget.init(this.defaultconfig),o.WebIMWidget.onShow=function(){o.WebIMWidget.setConversation(e.EnumConversationType.CUSTOMER_SERVICE,n.kefuId,"客服")}},n.prototype.show=function(){this.WebIMWidget.show()},n.prototype.hidden=function(){this.WebIMWidget.hidden()},n.$inject=["WebIMWidget"],n}();angular.module("RongCloudkefu",["RongWebIMWidget"]).service("RongKefu",n)}(RongWebIMWidget||(RongWebIMWidget={}));var RongWebIMWidget;!function(e){function t(e,t,n){var o="https:"===location.protocol?"https:":"http:";$script.get(o+"//cdn.ronghub.com/RongIMLib-2.1.1.min.js",function(){$script.get(o+"//cdn.ronghub.com/RongEmoji-2.1.1.min.js",function(){RongIMLib.RongIMEmoji&&RongIMLib.RongIMEmoji.init()}),$script.get(o+"//cdn.ronghub.com/RongIMVoice-2.1.1.min.js",function(){RongIMLib.RongIMVoice&&RongIMLib.RongIMVoice.init()}),n._config&&t.init(n._config)}),$script.get(o+"//cdn.bootcss.com/plupload/2.1.8/plupload.full.min.js",function(){})}t.$inject=["$http","WebIMWidget","WidgetConfig"];var n=function(){function e(){this.restrict="E",this.templateUrl="./src/ts/main.tpl.html",this.controller="rongWidgetController"}return e}(),o=function(){function t(t,n,o,i,r,s,a,c){this.$scope=t,this.$interval=n,this.WebIMWidget=o,this.WidgetConfig=i,this.providerdata=r,this.conversationServer=s,this.conversationListServer=a,this.RongIMSDKServer=c,t.main=o,t.config=i,t.data=r;var g=e.Helper.CookieHelper.getCookie("rongcloud.voiceSound");r.voiceSound=g?"true"==g:!0,t.$watch("data.voiceSound",function(t,n){t!==n&&e.Helper.CookieHelper.setCookie("rongcloud.voiceSound",t)});var u=null;t.$watch("data.totalUnreadCount",function(e,o){e>0?(u&&n.cancel(u),u=n(function(){t.twinkle=!t.twinkle},1e3)):n.cancel(u)}),t.$watch("main.display",function(){s.current&&s.current.targetId&&o.display&&c.getConversation(s.current.targetType,s.current.targetId).then(function(e){e&&e.unreadMessageCount>0&&(c.clearUnreadCount(s.current.targetType,s.current.targetId),c.sendReadReceiptMessage(s.current.targetId,s.current.targetType),a.updateConversations().then(function(){}))})}),o.show=function(){o.display=!0,o.fullScreen=!1,o.onShow&&o.onShow(),setTimeout(function(){t.$apply()})},o.hidden=function(){o.display=!1,setTimeout(function(){t.$apply()})},t.showbtn=function(){o.display=!0,o.onShow&&o.onShow()}}return t.$inject=["$scope","$interval","WebIMWidget","WidgetConfig","ProviderData","ConversationServer","ConversationListServer","RongIMSDKServer"],t}();angular.module("RongWebIMWidget").run(t).directive("rongWidget",e.DirectiveFactory.GetFactoryFor(n)).controller("rongWidgetController",o)}(RongWebIMWidget||(RongWebIMWidget={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},RongWebIMWidget;!function(e){!function(e){e[e.left=0]="left",e[e.right=1]="right"}(e.EnumConversationListPosition||(e.EnumConversationListPosition={}));e.EnumConversationListPosition;!function(e){e[e.PRIVATE=1]="PRIVATE",e[e.DISCUSSION=2]="DISCUSSION",e[e.GROUP=3]="GROUP",e[e.CHATROOM=4]="CHATROOM",e[e.CUSTOMER_SERVICE=5]="CUSTOMER_SERVICE",e[e.SYSTEM=6]="SYSTEM",e[e.APP_PUBLIC_SERVICE=7]="APP_PUBLIC_SERVICE",e[e.PUBLIC_SERVICE=8]="PUBLIC_SERVICE"}(e.EnumConversationType||(e.EnumConversationType={}));e.EnumConversationType;!function(e){e[e.SEND=1]="SEND",e[e.RECEIVE=2]="RECEIVE"}(e.MessageDirection||(e.MessageDirection={}));e.MessageDirection;!function(e){e[e.READ=1]="READ",e[e.LISTENED=2]="LISTENED",e[e.DOWNLOADED=4]="DOWNLOADED"}(e.ReceivedStatus||(e.ReceivedStatus={}));e.ReceivedStatus;!function(e){e[e.SENDING=10]="SENDING",e[e.FAILED=20]="FAILED",e[e.SENT=30]="SENT",e[e.RECEIVED=40]="RECEIVED",e[e.READ=50]="READ",e[e.DESTROYED=60]="DESTROYED"}(e.SentStatus||(e.SentStatus={}));var t;e.SentStatus;!function(e){e[e.left=1]="left",e[e.right=2]="right",e[e.top=3]="top",e[e.bottom=4]="bottom"}(t||(t={})),function(e){e[e.person=0]="person",e[e.robot=1]="robot",e[e.robotSwitchPerson=2]="robotSwitchPerson",e[e.notService=4]="notService"}(e.EnumInputPanelType||(e.EnumInputPanelType={}));e.EnumInputPanelType;e.MessageType={DiscussionNotificationMessage:"DiscussionNotificationMessage ",TextMessage:"TextMessage",ImageMessage:"ImageMessage",VoiceMessage:"VoiceMessage",RichContentMessage:"RichContentMessage",HandshakeMessage:"HandshakeMessage",UnknownMessage:"UnknownMessage",SuspendMessage:"SuspendMessage",LocationMessage:"LocationMessage",InformationNotificationMessage:"InformationNotificationMessage",ContactNotificationMessage:"ContactNotificationMessage",ProfileNotificationMessage:"ProfileNotificationMessage",CommandNotificationMessage:"CommandNotificationMessage",HandShakeResponseMessage:"HandShakeResponseMessage",ChangeModeResponseMessage:"ChangeModeResponseMessage",TerminateMessage:"TerminateMessage",CustomerStatusUpdateMessage:"CustomerStatusUpdateMessage",ReadReceiptMessage:"ReadReceiptMessage"},function(e){e[e.Message=1]="Message",e[e.InformationNotification=2]="InformationNotification",e[e.System=103]="System",e[e.Time=104]="Time",e[e.getHistory=105]="getHistory",e[e.getMore=106]="getMore",e[e.Other=0]="Other"}(e.PanelType||(e.PanelType={}));var n=e.PanelType,o=function(){function e(e){this.panelType=e}return e}();e.ChatPanel=o;var i=function(e){function t(t){e.call(this,n.Time),this.sentTime=t}return __extends(t,e),t}(o);e.TimePanl=i;var r=function(e){function t(){e.call(this,n.getHistory)}return __extends(t,e),t}(o);e.GetHistoryPanel=r;var s=function(e){function t(){e.call(this,n.getMore)}return __extends(t,e),t}(o);e.GetMoreMessagePanel=s;var a=function(e){function t(t){e.call(this,n.Time),this.sentTime=t}return __extends(t,e),t}(o);e.TimePanel=a;var c=function(t){function o(e,o,i,r,s,a,c,g,u,l,d,p,v){t.call(this,n.Message)}return __extends(o,t),o.convert=function(t){var n=new o;switch(n.conversationType=t.conversationType,n.extra=t.extra,n.objectName=t.objectName,n.messageDirection=t.messageDirection,n.messageId=t.messageId,n.receivedStatus=t.receivedStatus,n.receivedTime=new Date(t.receivedTime),n.senderUserId=t.senderUserId,n.sentStatus=t.sendStatusMessage,n.sentTime=new Date(t.sentTime),n.targetId=t.targetId,n.messageType=t.messageType,n.messageType){case e.MessageType.TextMessage:var i=new l,r=t.content.content;r=e.Helper.escapeSymbol.escapeHtml(r),RongIMLib.RongIMEmoji&&RongIMLib.RongIMEmoji.emojiToHTML&&(r=RongIMLib.RongIMEmoji.emojiToHTML(r)),i.content=r,n.content=i;break;case e.MessageType.ImageMessage:var s=new h,r=t.content.content||"";-1==r.indexOf("base64,")&&(r="data:image/png;base64,"+r),s.content=r,s.imageUri=t.content.imageUri,n.content=s;break;case e.MessageType.VoiceMessage:var a=new y;a.content=t.content.content,a.duration=t.content.duration,n.content=a;break;case e.MessageType.RichContentMessage:var c=new M;c.content=t.content.content,c.title=t.content.title,c.imageUri=t.content.imageUri,n.content=c;break;case e.MessageType.LocationMessage:var g=new I,r=t.content.content||"";-1==r.indexOf("base64,")&&(r="data:image/png;base64,"+r),g.content=r,g.latiude=t.content.latiude,g.longitude=t.content.longitude,g.poi=t.content.poi,n.content=g;break;case e.MessageType.InformationNotificationMessage:var u=new m;n.panelType=2,u.content=t.content.message,n.content=u;break;case e.MessageType.DiscussionNotificationMessage:var S=new b;S.extension=t.content.extension,S.operation=t.content.operation,S.type=t.content.type,S.isHasReceived=t.content.isHasReceived,n.content=S;case e.MessageType.HandShakeResponseMessage:var C=new d;C.status=t.content.status,C.msg=t.content.msg,C.data=t.content.data,n.content=C;break;case e.MessageType.ChangeModeResponseMessage:var R=new p;R.code=t.content.code,R.data=t.content.data,R.status=t.content.status,n.content=R;break;case e.MessageType.CustomerStatusUpdateMessage:var T=new f;T.serviceStatus=t.content.serviceStatus,n.content=T;break;case e.MessageType.TerminateMessage:var w=new v;w.code=t.content.code,n.content=w}return n.content&&(n.content.userInfo=t.content.user),n},o.messageToNotification=function(t){if(!t)return null;var n,o=t.messageType;if(o==e.MessageType.ImageMessage)n="[图片]";else if(o==e.MessageType.LocationMessage)n="[位置]";else if(o==e.MessageType.VoiceMessage)n="[语音]";else if(o==e.MessageType.ContactNotificationMessage||o==e.MessageType.CommandNotificationMessage)n="[通知消息]";else if("RC:GrpNtf"==t.objectName){var i=t.content.message.content.data.data;switch(t.content.message.content.operation){case"Add":n=i.targetUserDisplayNames?i.targetUserDisplayNames.join("、")+" 加入了群组":"加入群组";break;case"Quit":n=i.operatorNickname+" 退出了群组";break;case"Kicked":n=i.targetUserDisplayNames?i.targetUserDisplayNames.join("、")+" 被剔出群组":"移除群组";break;case"Rename":n=i.operatorNickname+" 修改了群名称";break;case"Create":n=i.operatorNickname+" 创建了群组";break;case"Dismiss":n=i.operatorNickname+" 解散了群组 "+i.targetGroupName}}else n=t.content?t.content.content:"",n=RongIMLib.RongIMEmoji.emojiToSymbol(n),n=n.replace(/\n/g," "),n=n.replace(/([\w]{49,50})/g,"$1 ");return n},o}(o);e.Message=c;var g=function(){function e(e,t,n){this.userId=e,this.name=t,this.portraitUri=n}return e}();e.UserInfo=g;var u=function(){function e(e,t,n){this.userId=e,this.name=t,this.portraitUri=n}return e}();e.GroupInfo=u;var l=function(){function e(e){e=e||{},this.content=e.content,this.userInfo=e.userInfo}return e}();e.TextMessage=l;var d=function(){function e(){}return e}();e.HandShakeResponseMessage=d;var p=function(){function e(){}return e}();e.ChangeModeResponseMessage=p;var v=function(){function e(){}return e}();e.TerminateMessage=v;var f=function(){function e(){}return e}();e.CustomerStatusUpdateMessage=f;var m=function(){function e(){}return e}();e.InformationNotificationMessage=m;var h=function(){function e(){}return e}();e.ImageMessage=h;var y=function(){function e(){}return e}();e.VoiceMessage=y;var I=function(){function e(){}return e}();e.LocationMessage=I;var M=function(){function e(){}return e}();e.RichContentMessage=M;var b=function(){function e(){}return e}();e.DiscussionNotificationMessage=b;var S=function(){function e(e,t,n){this.targetType=e,this.targetId=t,this.title=n||""}return e.onvert=function(t){var n=new e;return n.targetId=t.targetId,n.targetType=t.conversationType,n.title=t.conversationTitle,n.portraitUri=t.senderPortraitUri,n.unreadMessageCount=t.unreadMessageCount,n},e}();e.Conversation=S}(RongWebIMWidget||(RongWebIMWidget={}));var RongWebIMWidget;!function(e){var t=function(){function e(e){var t=this;this.$q=e,this.connect=function(e){var n=t.$q.defer();return RongIMLib.RongIMClient.connect(e,{onSuccess:function(e){n.resolve(e)},onTokenIncorrect:function(){n.reject({tokenError:!0})},onError:function(e){n.reject({errorCode:e});var t="";switch(e){case RongIMLib.ErrorCode.TIMEOUT:t="连接超时";break;case RongIMLib.ErrorCode.UNKNOWN:t="未知错误";break;case RongIMLib.ConnectionState.UNACCEPTABLE_PROTOCOL_VERSION:t="不可接受的协议版本";break;case RongIMLib.ConnectionState.IDENTIFIER_REJECTED:t="appkey不正确";break;case RongIMLib.ConnectionState.SERVER_UNAVAILABLE:t="服务器不可用";break;case RongIMLib.ConnectionState.NOT_AUTHORIZED:t="未认证";break;case RongIMLib.ConnectionState.REDIRECT:t="重新获取导航";break;case RongIMLib.ConnectionState.APP_BLOCK_OR_DELETE:t="应用已被封禁或已被删除";break;case RongIMLib.ConnectionState.BLOCK:t="用户被封禁"}console.log("失败:"+t);
}}),n.promise},this.getConversation=function(e,n){var o=t.$q.defer();return RongIMLib.RongIMClient.getInstance().getConversation(Number(e),n,{onSuccess:function(e){o.resolve(e)},onError:function(){o.reject()}}),o.promise},this.getFileToken=function(){var e=t.$q.defer();return RongIMLib.RongIMClient.getInstance().getFileToken(RongIMLib.FileType.IMAGE,{onSuccess:function(t){t?e.resolve(t.token):e.reject()},onError:function(){e.reject()}}),e.promise}}return e.prototype.init=function(e){RongIMLib.RongIMClient.init(e)},e.prototype.setOnReceiveMessageListener=function(e){RongIMLib.RongIMClient.setOnReceiveMessageListener(e)},e.prototype.setConnectionStatusListener=function(e){RongIMLib.RongIMClient.setConnectionStatusListener(e)},e.prototype.startCustomService=function(e){var t=this.$q.defer();return RongIMLib.RongIMClient.getInstance().startCustomService(e,{onSuccess:function(){t.resolve()},onError:function(){t.reject()}}),t.promise},e.prototype.sendReadReceiptMessage=function(e,t){var n=this;RongIMLib.RongIMClient.getInstance().getConversation(Number(t),e,{onSuccess:function(o){if(o){var i=RongIMLib.ReadReceiptMessage.obtain(o.latestMessage.messageUId,o.latestMessage.sentTime,"1");n.sendMessage(t,e,i)}},onError:function(){}})},e.prototype.sendMessage=function(e,t,n){var o=this.$q.defer();return RongIMLib.RongIMClient.getInstance().sendMessage(+e,t,n,{onSuccess:function(e){o.resolve(e)},onError:function(e,t){o.reject({errorCode:e,message:t});var n="";switch(e){case RongIMLib.ErrorCode.TIMEOUT:n="超时";break;case RongIMLib.ErrorCode.UNKNOWN:n="未知错误";break;case RongIMLib.ErrorCode.REJECTED_BY_BLACKLIST:n="在黑名单中，无法向对方发送消息";break;case RongIMLib.ErrorCode.NOT_IN_DISCUSSION:n="不在讨论组中";break;case RongIMLib.ErrorCode.NOT_IN_GROUP:n="不在群组中";break;case RongIMLib.ErrorCode.NOT_IN_CHATROOM:n="不在聊天室中";break;default:n=""}console.log("发送失败:"+n)}}),o.promise},e.prototype.evaluateHumanCustomService=function(e,t,n){var o=this.$q.defer();return RongIMLib.RongIMClient.getInstance().evaluateHumanCustomService(e,t,n,{onSuccess:function(){o.resolve()},onError:function(){o.reject()}}),o.promise},e.prototype.reconnect=function(e){RongIMLib.RongIMClient.reconnect(e)},e.prototype.disconnect=function(){RongIMLib.RongIMClient.getInstance().disconnect()},e.prototype.logout=function(){RongIMLib&&RongIMLib.RongIMClient&&RongIMLib.RongIMClient.getInstance().logout()},e.prototype.clearUnreadCount=function(e,t){var n=this.$q.defer();return RongIMLib.RongIMClient.getInstance().clearUnreadCount(e,t,{onSuccess:function(e){n.resolve(e)},onError:function(e){n.reject(e)}}),n.promise},e.prototype.getTotalUnreadCount=function(){var e=this.$q.defer();return RongIMLib.RongIMClient.getInstance().getTotalUnreadCount({onSuccess:function(t){e.resolve(t)},onError:function(){e.reject()}}),e.promise},e.prototype.getConversationList=function(){var e=this.$q.defer();return RongIMLib.RongIMClient.getInstance().getConversationList({onSuccess:function(t){e.resolve(t)},onError:function(t){e.reject(t)}},null),e.promise},e.prototype.removeConversation=function(e,t){var n=this.$q.defer();return RongIMLib.RongIMClient.getInstance().removeConversation(e,t,{onSuccess:function(e){n.resolve(e)},onError:function(e){n.reject(e)}}),n.promise},e.prototype.getHistoryMessages=function(e,t,n){var o=this.$q.defer();return RongIMLib.RongIMClient.getInstance().getHistoryMessages(e,t,null,n,{onSuccess:function(e,t){o.resolve({data:e,has:t})},onError:function(e){o.reject(e)}}),o.promise},e.prototype.getDraft=function(e,t){return RongIMLib.RongIMClient.getInstance().getTextMessageDraft(e,t)||""},e.prototype.setDraft=function(e,t,n){return RongIMLib.RongIMClient.getInstance().saveTextMessageDraft(e,t,n)},e.prototype.clearDraft=function(e,t){return RongIMLib.RongIMClient.getInstance().clearTextMessageDraft(e,t)},e.$inject=["$q"],e}();e.RongIMSDKServer=t,angular.module("RongWebIMWidget").service("RongIMSDKServer",t)}(RongWebIMWidget||(RongWebIMWidget={}));var RongWebIMWidget;!function(e){var t=function(){function e(){this._cacheUserInfo=[],this._cacheGroupInfo=[],this.totalUnreadCount=0,this.connectionState=!1,this.voiceSound=!1,this.currentUserInfo={}}return e.prototype._getCacheUserInfo=function(e){for(var t=0,n=this._cacheUserInfo.length;n>t;t++)if(this._cacheUserInfo[t].userId==e)return this._cacheUserInfo[t];return null},e.prototype._addUserInfo=function(e){var t=this._getCacheUserInfo(e.userId);t?angular.extend(t,e):this._cacheUserInfo.push(e)},e}();e.ProviderData=t;var n=(function(){function e(){}return e}(),function(){function t(){this.displayConversationList=!1,this.conversationListPosition=e.EnumConversationListPosition.left,this.displayMinButton=!0,this.desktopNotification=!1,this.reminder="",this.voiceNotification=!1,this.style={positionFixed:!1,width:450,height:470,bottom:0,right:0},this.refershOnlineStateIntercycle=2e4,this.__isKefu=!1}return t}());e.WidgetConfig=n,angular.module("RongWebIMWidget").service("ProviderData",t).service("WidgetConfig",n)}(RongWebIMWidget||(RongWebIMWidget={})),angular.module("RongWebIMWidget").run(["$templateCache",function(e){"use strict";e.put("./src/ts/conversation/conversation.tpl.html",'<div id=rong-conversation class="rongcloud-kefuChatBox rongcloud-both rongcloud-am-fade-and-slide-top" ng-show=showSelf ng-class="{\'rongcloud-fullScreen\':resoures.fullScreen}"><evaluatedir type=evaluate.type display=evaluate.showSelf confirm=evaluate.onConfirm(data) cancle=evaluate.onCancle()></evaluatedir><div class=rongcloud-kefuChat><div id=header class="rongcloud-rong-header rongcloud-blueBg rongcloud-online"><div class="rongcloud-infoBar rongcloud-pull-left"><div class=rongcloud-infoBarTit><span class=rongcloud-kefuName ng-bind=conversation.title></span></div></div><div class="rongcloud-toolBar rongcloud-headBtn rongcloud-pull-right"><div ng-show=!config.displayConversationList&&config.voiceNotification class=rongcloud-voice ng-class="{\'rongcloud-voice-mute\':!data.voiceSound,\'rongcloud-voice-sound\':data.voiceSound}" ng-click="data.voiceSound=!data.voiceSound"></div><a href=javascript:; class="rongcloud-kefuChatBoxHide rongcloud-sprite" style=margin-right:6px ng-show=!config.displayConversationList ng-click=minimize() title=隐藏></a> <a href=javascript:; class="rongcloud-kefuChatBoxClose rongcloud-sprite" ng-click=close() title=结束对话></a></div></div><div class=rongcloud-outlineBox ng-hide=data.connectionState><div class=rongcloud-sprite></div><span>连接断开,请刷新重连</span></div><div id=Messages><div class=rongcloud-emptyBox>暂时没有新消息</div><div class=rongcloud-MessagesInner><div ng-repeat="item in messageList" ng-switch=item.panelType><div class=rongcloud-Messages-date ng-switch-when=104><b>{{item.sentTime|historyTime}}</b></div><div class=rongcloud-Messages-history ng-switch-when=105><b ng-click=getHistory()>查看历史消息</b></div><div class=rongcloud-Messages-history ng-switch-when=106><b ng-click=getMoreMessage()>获取更多消息</b></div><div class=rongcloud-sys-tips ng-switch-when=2><span ng-bind-html=item.content.content|trustHtml></span></div><div class=rongcloud-Message ng-switch-when=1><div class=rongcloud-Messages-unreadLine></div><div><div class=rongcloud-Message-header><img class="rongcloud-img rongcloud-u-isActionable rongcloud-Message-avatar rongcloud-avatar" ng-src={{item.content.userInfo.portraitUri||item.content.userInfo.icon}} err-src=http://7xo1cb.com1.z0.glb.clouddn.com/rongcloudkefu2.png errsrcserasdfasdfasdfa alt=""><div class="rongcloud-Message-author rongcloud-clearfix"><a class="rongcloud-author rongcloud-u-isActionable">{{item.content.userInfo.name}}</a></div></div></div><div class=rongcloud-Message-body ng-switch=item.messageType><textmessage ng-switch-when=TextMessage msg=item.content></textmessage><imagemessage ng-switch-when=ImageMessage msg=item.content></imagemessage><voicemessage ng-switch-when=VoiceMessage msg=item.content></voicemessage><locationmessage ng-switch-when=LocationMessage msg=item.content></locationmessage><richcontentmessage ng-switch-when=RichContentMessage msg=item.content></richcontentmessage></div></div></div></div></div><div id=footer class=rongcloud-rong-footer style="display: block"><div class=rongcloud-footer-con><div class=rongcloud-text-layout><div id=funcPanel class="rongcloud-funcPanel rongcloud-robotMode"><div class=rongcloud-mode1 ng-show="_inputPanelState==0"><div class=rongcloud-MessageForm-tool id=expressionWrap><i class="rongcloud-sprite rongcloud-iconfont-smile" ng-click="showemoji=!showemoji"></i><div class=rongcloud-expressionWrap ng-show=showemoji><i class=rongcloud-arrow></i><emoji ng-repeat="item in emojiList" item=item content=conversation></emoji></div></div><div class=rongcloud-MessageForm-tool><i class="rongcloud-sprite rongcloud-iconfont-upload" id=upload-file style="position: relative; z-index: 1"></i></div></div><div class=rongcloud-mode2 ng-show="_inputPanelState==2"><a ng-click=switchPerson() id=chatSwitch class=rongcloud-chatSwitch>转人工服务</a></div></div><pre id=inputMsg class="rongcloud-text rongcloud-grey" contenteditable contenteditable-dire ng-focus="showemoji=fase" style="background-color: rgba(0,0,0,0);color:black" ctrl-enter-keys fun=send() ctrlenter=false placeholder=请输入文字... ondrop="return false" ng-model=conversation.messageContent></pre></div><div class=rongcloud-powBox><button type=button style="background-color: #0099ff" class="rongcloud-rong-btn rongcloud-rong-send-btn" id=rong-sendBtn ng-click=send()>发送</button></div></div></div></div></div>'),e.put("./src/ts/conversationlist/conversationList.tpl.html",'<div id=rong-conversation-list class="rongcloud-kefuListBox rongcloud-both"><div class=rongcloud-kefuList><div class="rongcloud-rong-header rongcloud-blueBg"><div class="rongcloud-toolBar rongcloud-headBtn"><div ng-show=config.voiceNotification class=rongcloud-voice ng-class="{\'rongcloud-voice-mute\':!data.voiceSound,\'rongcloud-voice-sound\':data.voiceSound}" ng-click="data.voiceSound=!data.voiceSound"></div><div class="rongcloud-sprite rongcloud-people"></div><span class=rongcloud-recent>最近联系人</span><div class="rongcloud-sprite rongcloud-arrow-down" style="cursor: pointer" ng-click=minbtn()></div></div></div><div class=rongcloud-content><div class=rongcloud-netStatus ng-hide=data.connectionState><div class=rongcloud-sprite></div><span>连接断开,请刷新重连</span></div><div><conversation-item ng-repeat="item in conversationListServer._conversationList" item=item></conversation-item></div></div></div></div>'),e.put("./src/ts/evaluate/evaluate.tpl.html",'<div class=rongcloud-layermbox ng-show=display><div class=rongcloud-laymshade></div><div class=rongcloud-layermmain><div class=rongcloud-section><div class=rongcloud-layermchild ng-show=!end><div class=rongcloud-layermcont><div class=rongcloud-type1 ng-show="type==1"><h4>&nbsp;评价客服</h4><div class=rongcloud-layerPanel1><div class=rongcloud-star><span ng-repeat="item in stars track by $index"><span ng-class="{\'rongcloud-star-on\':$index<data.stars,\'rongcloud-star-off\':$index>=data.stars}" ng-click=confirm($index+1) ng-mouseenter=mousehover($index+1) ng-mouseleave=mousehover(0)></span></span></div></div></div><div class=rongcloud-type2 ng-show="type==2"><h4>&nbsp;&nbsp;机器人是否解决了您的问题 ？</h4><div class=rongcloud-layerPanel1><a class="rongcloud-rong-btn rongcloud-btnY" ng-class="{\'rongcloud-cur\':data.value===true}" href=javascript:void(0); ng-click=confirm(true)>是</a> <a class="rongcloud-rong-btn rongcloud-btnN" ng-class="{\'rongcloud-cur\':data.value===false}" href=javascript:void(0); ng-click=confirm(false)>否</a></div></div><div class=rongcloud-layerPanel2 ng-show=displayDescribe><p>是否有以下情况 ？</p><div class=rongcloud-labels><span ng-repeat="item in labels"><a class=rongcloud-rong-btn ng-class="{\'rongcloud-cur\':item.selected}" ng-click="item.selected=!item.selected" href="">{{item.display}}</a></span></div><div class=rongcloud-suggestBox><textarea name="" placeholder=欢迎给我们的服务提建议~ ng-model=data.describe></textarea></div><div class=rongcloud-subBox><a class=rongcloud-rong-btn href="" ng-click=commit()>提交评价</a></div></div></div><div class=rongcloud-layermbtn><span ng-click=confirm()>跳过</span><span ng-click=cancle()>取消</span></div></div><div class="rongcloud-layermchild rongcloud-feedback" ng-show=end><div class=rongcloud-layermcont>感谢您的反馈 ^ - ^ ！</div></div></div></div></div>'),e.put("./src/ts/main.tpl.html",'<div id=rong-widget-box class=rongcloud-container><div ng-show=main.display><rong-conversation></rong-conversation><rong-conversation-list></rong-conversation-list></div><div id=rong-widget-minbtn class="rongcloud-kefuBtnBox rongcloud-blueBg" ng-show=!main.display&&config.displayMinButton ng-click=showbtn()><a class=rongcloud-kefuBtn href="javascript: void(0);"><div class="rongcloud-sprite rongcloud-people"></div><span class=rongcloud-recent ng-show="!data.totalUnreadCount||data.totalUnreadCount==0">{{config.reminder||"最近联系人"}}</span> <span class=rongcloud-recent ng-show="data.totalUnreadCount>0"><span ng-show=twinkle>(有未读消息)</span></span></a></div><div id=rong-widget-minbtn-kefu class="rongcloud-kefuBtnBox rongcloud-blueBg" ng-show=!main.display&&config.displayMinButton ng-click=showbtn()><a class=rongcloud-kefuBtn href="javascript: void(0);"><div class="rongcloud-sprite rongcloud-people rongcloud-sprite-kefu"></div><span class=rongcloud-recent>{{config.reminder||"联系客服"}}</span></a></div><audio id=rongcloud-playsound style="width: 0px;height: 0px;display: none" src="" controls></audio></div>')}]),function(e,t){"undefined"!=typeof module&&module.exports?module.exports=t():"function"==typeof define&&define.amd?define(t):this[e]=t()}("$script",function(){function e(e,t){for(var n=0,o=e.length;o>n;++n)if(!t(e[n]))return c;return 1}function t(t,n){e(t,function(e){return!n(e)})}function n(r,s,a){function c(e){return e.call?e():d[e]}function u(){if(!--y){d[h]=1,m&&m();for(var n in v)e(n.split("|"),c)&&!t(v[n],c)&&(v[n]=[])}}r=r[g]?r:[r];var l=s&&s.call,m=l?s:a,h=l?r.join(""):s,y=r.length;return setTimeout(function(){t(r,function e(t,n){return null===t?u():(!n&&!/^https?:\/\//.test(t)&&i&&(t=-1===t.indexOf(".js")?i+t+".js":i+t),f[t]?(h&&(p[h]=1),2==f[t]?u():setTimeout(function(){e(t,!0)},0)):(f[t]=1,h&&(p[h]=1),o(t,u),void 0))})},0),n}function o(e,t){var n,o=s.createElement("script");o.onload=o.onerror=o[l]=function(){o[u]&&!/^c|loade/.test(o[u])||n||(o.onload=o[l]=null,n=1,f[e]=2,t())},o.async=1,o.src=r?e+(-1===e.indexOf("?")?"?":"&")+r:e,a.insertBefore(o,a.lastChild)}var i,r,s=document,a=s.getElementsByTagName("head")[0],c=!1,g="push",u="readyState",l="onreadystatechange",d={},p={},v={},f={};return n.get=o,n.order=function(e,t,o){!function i(r){r=e.shift(),e.length?n(r,i):n(r,t,o)}()},n.path=function(e){i=e},n.urlArgs=function(e){r=e},n.ready=function(o,i,r){o=o[g]?o:[o];var s=[];return!t(o,function(e){d[e]||s[g](e)})&&e(o,function(e){return d[e]})?i():!function(e){v[e]=v[e]||[],v[e][g](i),r&&r(s)}(o.join("|")),n},n.done=function(e){n([null],e)},n});var Qiniu=new QiniuJsSDK;